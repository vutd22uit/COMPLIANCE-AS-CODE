# CIS AWS Foundations Benchmark 2.1.4
# Ensure S3 buckets are configured with 'Block public access'

control:
  id: "CIS-AWS-2.1.4"

  standard: "CIS AWS Foundations Benchmark v1.5.0"

  aliases:
    - "AWS-S3-PUBLIC-BLOCK"

  section: "2.1 Simple Storage Service (S3)"

  title: "Ensure S3 buckets are configured with 'Block public access'"

  description: |
    Amazon S3 'Block Public Access' provides settings to help manage public access
    to S3 resources. By default, new buckets and objects don't allow public access.
    However, users can modify bucket policies or object permissions to allow public access.

    S3 Block Public Access settings override these policies and permissions, providing
    an additional layer of protection against inadvertent public exposure of data.

    This control ensures that all four S3 Block Public Access settings are enabled:
    - BlockPublicAcls
    - IgnorePublicAcls
    - BlockPublicPolicy
    - RestrictPublicBuckets

  severity: "CRITICAL"

  rationale: |
    Publicly accessible S3 buckets pose a significant data breach risk. Numerous
    high-profile data breaches have occurred due to misconfigured S3 bucket permissions.

    Enabling S3 Block Public Access provides defense-in-depth protection, ensuring
    that even if bucket policies or ACLs are misconfigured, public access is still
    prevented.

  impact: |
    Enabling these settings will:
    - Prevent new public bucket policies from being applied
    - Prevent existing public bucket policies from granting public access
    - Prevent public ACLs from granting public access
    - Ignore existing public ACLs

    This may impact legitimate use cases requiring public access (e.g., static
    website hosting). Such cases should use CloudFront distributions instead.

  domains:
    - "data-protection"
    - "access-control"
    - "cloud-security"

  provider: "aws"
  services:
    - "s3"

  iac_checks:
    - tool: "checkov"
      check_id: "CKV_AWS_21"
      description: "Ensure S3 bucket has 'Block Public Access' block on"
      enabled: true
      severity_override: null

    - tool: "checkov"
      check_id: "CKV_AWS_53"
      description: "Ensure S3 bucket has block public ACLs enabled"
      enabled: true

    - tool: "checkov"
      check_id: "CKV_AWS_54"
      description: "Ensure S3 bucket has block public policy enabled"
      enabled: true

    - tool: "checkov"
      check_id: "CKV_AWS_55"
      description: "Ensure S3 bucket has ignore public ACLs enabled"
      enabled: true

    - tool: "checkov"
      check_id: "CKV_AWS_56"
      description: "Ensure S3 bucket has restrict public buckets enabled"
      enabled: true

    - tool: "opa"
      policy_file: "policies/rego/s3.rego"
      package: "terraform.s3"
      rule: "deny"
      enabled: true

    - tool: "tfsec"
      check_id: "aws-s3-block-public-acls"
      enabled: true

    - tool: "tfsec"
      check_id: "aws-s3-block-public-policy"
      enabled: true

  runtime_checks:
    - tool: "inspec"
      profile: "aws-cis"
      control_id: "cis-aws-2-1-4"
      enabled: true
      frequency: "hourly"
      resource: "aws_s3_bucket_public_access_block"

    - tool: "aws_config"
      rule_name: "s3-bucket-public-read-prohibited"
      rule_type: "managed"
      managed_rule_identifier: "S3_BUCKET_PUBLIC_READ_PROHIBITED"
      enabled: true

    - tool: "aws_config"
      rule_name: "s3-bucket-public-write-prohibited"
      rule_type: "managed"
      managed_rule_identifier: "S3_BUCKET_PUBLIC_WRITE_PROHIBITED"
      enabled: true

    - tool: "scoutsuite"
      check_path: "services.s3.buckets.public"
      enabled: true
      frequency: "daily"

  enforcement:
    mode: "block"

    actions:
      - type: "block_iac"
        enabled: true
        tools: ["checkov", "opa", "tfsec"]
        message: |
          CRITICAL: S3 bucket must have all public access block settings enabled.
          This is a CIS AWS Foundations Benchmark requirement (2.1.4).

      - type: "alert"
        enabled: true
        channels:
          - type: "slack"
            webhook: "compliance-critical"
            severity_threshold: "CRITICAL"
          - type: "email"
            recipients:
              - "security@company.com"
              - "compliance@company.com"
              - "ciso@company.com"
          - type: "sns"
            topic_arn: "arn:aws:sns:us-east-1:123456789012:critical-security-alerts"

      - type: "ticket"
        enabled: true
        system: "jira"
        project: "SEC"
        issue_type: "Security Incident"
        priority_mapping:
          CRITICAL: "P1"
        labels:
          - "compliance"
          - "cis-aws"
          - "s3-public"
          - "data-breach-risk"

      - type: "remediate"
        enabled: true
        tools:
          - "custodian"
        approval_required: false  # Auto-remediate immediately for CRITICAL
        max_auto_remediation_time: "5 minutes"

  remediation:
    automated: true

    methods:
      - tool: "custodian"
        policy_file: "policies/custodian/s3-compliance.yml"
        policy_name: "s3-enforce-block-public-access"
        description: "Automatically enable all public access block settings"
        risk_level: "LOW"
        estimated_time: "30 seconds"

      - tool: "aws_config"
        remediation_action: "AWS-PublishSNSNotification"
        auto_remediation: true
        parameters:
          TopicArn: "arn:aws:sns:us-east-1:123456789012:config-remediation"
          Message: "S3 bucket public access block has been enabled"

      - tool: "lambda"
        function_name: "s3-enforce-public-block"
        runtime: "python3.11"
        code_path: "remediation/lambda/s3_public_block.py"

    manual_steps:
      - "1. Log into AWS Console"
      - "2. Navigate to S3 service"
      - "3. Select the non-compliant bucket"
      - "4. Go to 'Permissions' tab"
      - "5. Under 'Block public access (bucket settings)', click 'Edit'"
      - "6. Enable all four settings:"
      - "   - Block public access to buckets and objects granted through new access control lists (ACLs)"
      - "   - Block public access to buckets and objects granted through any access control lists (ACLs)"
      - "   - Block public access to buckets and objects granted through new public bucket or access point policies"
      - "   - Block public and cross-account access to buckets and objects through any public bucket or access point policies"
      - "7. Click 'Save changes'"
      - "8. Confirm by typing 'confirm'"

    estimated_time: "2 minutes"
    risk_level: "LOW"

    verification:
      - "Run InSpec control: inspec exec tests/inspec/aws-cis -t aws:// --controls cis-aws-2-1-4"
      - "Check AWS Config compliance dashboard"
      - "Verify in AWS Console: S3 → Bucket → Permissions → Block public access shows all enabled"

  evidence:
    - type: "scan_report"
      format: "json"
      source: "inspec"
      retention_days: 2555

    - type: "scan_report"
      format: "json"
      source: "checkov"
      retention_days: 2555

    - type: "aws_config_snapshot"
      format: "json"
      retention_days: 2555

    - type: "remediation_log"
      format: "json"
      retention_days: 2555
      includes:
        - timestamp
        - bucket_name
        - previous_state
        - new_state
        - remediation_method
        - triggered_by

    storage:
      type: "s3"
      bucket: "compliance-evidence"
      prefix: "controls/CIS-AWS-2.1.4/"
      encryption: "aws:kms"
      kms_key_id: "arn:aws:kms:us-east-1:123456789012:key/compliance-evidence"

  exceptions:
    allowed: false
    reason: "S3 public access is a critical security control with no acceptable exceptions"
    alternative: "Use CloudFront distribution with signed URLs for legitimate public access needs"

  testing:
    unit_tests:
      - "tests/unit/test_s3_public_block_rego.py"
      - "tests/unit/test_s3_public_block_inspec.rb"

    integration_tests:
      - "tests/integration/test_s3_public_block_remediation.py"

    test_frequency: "on_commit"

    test_scenarios:
      - name: "Compliant bucket - all blocks enabled"
        expected: "PASS"

      - name: "Non-compliant - BlockPublicAcls disabled"
        expected: "FAIL"

      - name: "Non-compliant - no public access block configured"
        expected: "FAIL"

      - name: "Remediation - auto-enable all blocks"
        expected: "REMEDIATED"

  metrics:
    - name: "compliance_rate"
      description: "Percentage of S3 buckets with public access blocked"
      formula: "(compliant_buckets / total_buckets) * 100"
      target: 100
      current: 98.5

    - name: "mean_time_to_remediate"
      description: "Average time to fix public bucket violations"
      unit: "minutes"
      target: 5
      current: 2

    - name: "false_positive_rate"
      description: "Percentage of false positives"
      formula: "(false_positives / total_findings) * 100"
      target: 0
      current: 0

    - name: "auto_remediation_success_rate"
      description: "Success rate of automatic remediation"
      formula: "(successful_remediations / total_remediations) * 100"
      target: 99
      current: 99.8

  references:
    - type: "documentation"
      title: "AWS S3 Block Public Access"
      url: "https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html"

    - type: "benchmark"
      title: "CIS AWS Foundations Benchmark v1.5.0"
      section: "2.1.4"
      url: "https://www.cisecurity.org/benchmark/amazon_web_services"

    - type: "aws_blog"
      title: "Amazon S3 Block Public Access"
      url: "https://aws.amazon.com/blogs/aws/amazon-s3-block-public-access-another-layer-of-protection-for-your-accounts-and-buckets/"

    - type: "breach_example"
      title: "Capital One Data Breach"
      description: "Example of S3 misconfiguration leading to data breach"
      url: "https://krebsonsecurity.com/2019/07/capital-one-data-theft-impacts-106m-people/"

  change_history:
    - date: "2025-12-07"
      version: "1.0"
      author: "Cloud Security Team"
      changes: "Initial control definition with full automation"

    - date: "2025-12-07"
      version: "1.1"
      author: "Cloud Security Team"
      changes: "Added CloudTrail event-driven remediation"

  status: "active"

  implementation:
    iac_checks: "completed"
    runtime_checks: "completed"
    enforcement: "completed"
    remediation: "completed"
    evidence: "completed"

  owner:
    team: "Cloud Security Team"
    contact: "cloud-security@company.com"
    slack_channel: "#cloud-security"

  review:
    frequency: "quarterly"
    next_review_date: "2026-03-07"
    last_reviewed: "2025-12-07"
    reviewed_by: "Senior Security Architect"
    review_notes: "Control fully automated and operational. Zero exceptions granted."
